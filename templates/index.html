<html lang="en" class="scroll-smooth"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AeroAqua | Atmospheric Intelligence V.2.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap');

        :root {
            --voltage-cyan: #22d3ee;
            --voltage-yellow: #facc15;
            --voltage-emerald: #34d399;
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #334155; }
        
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px;
            border-radius: 50%; background: #ffffff;
            border: 2px solid #0f172a; cursor: pointer;
            margin-top: -6px; box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer;
            background: #334155; border-radius: 2px;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1) opacity(0.5);
            cursor: pointer;
        }

        .font-mono-jb { font-family: 'JetBrains Mono', monospace; }
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        @keyframes draw-line {
            0% { width: 0; }
            100% { width: 100%; }
        }
        .animate-draw { animation: draw-line 2s ease-out forwards; }
        
        @keyframes pulse-glow {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        .animate-pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
        
        .loading-skeleton {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Tooltip animation */
        .chart-tooltip {
            transition: opacity 0.2s, transform 0.2s;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-300 font-sans antialiased selection:bg-cyan-500/30 selection:text-cyan-200">

    <nav class="fixed top-0 w-full z-50 border-b border-white/5 bg-slate-950/80 backdrop-blur-md">
        <div class="max-w-7xl mx-auto px-6 h-14 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <i data-lucide="zap" class="text-cyan-400 w-5 h-5 fill-cyan-400/20"></i>
                <span class="text-slate-100 tracking-tighter font-semibold text-lg">AEROAQUA</span>
            </div>
            <div class="hidden md:flex items-center gap-8 text-sm font-medium text-slate-400">
                <a href="#dashboard" class="hover:text-slate-100 transition-colors">Live Telemetry</a>
                <a href="#history" class="hover:text-slate-100 transition-colors">History</a>
                <a href="#tech-stack" class="hover:text-slate-100 transition-colors">Tech Stack</a>
            </div>
            <div class="flex items-center gap-3">
                <div id="system-status" class="hidden sm:flex items-center gap-2 px-3 py-1 rounded-full bg-emerald-500/10 border border-emerald-500/20">
                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                    <span class="text-xs font-mono-jb text-emerald-400 tracking-tight uppercase">System Online</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Global Tooltip for Charts -->
    <div id="global-tooltip" class="fixed hidden z-[100] glass-panel p-3 rounded-lg border border-slate-700 shadow-xl pointer-events-none transform -translate-x-1/2 -translate-y-full mt-[-10px]">
        <div id="tooltip-date" class="text-xs font-mono-jb text-slate-400 mb-2 pb-2 border-b border-white/10"></div>
        <div class="space-y-1">
            <div class="flex items-center justify-between gap-4 text-xs">
                <span class="text-cyan-400 flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-cyan-400"></span> Fog</span>
                <span id="tooltip-fog" class="font-mono-jb text-white"></span>
            </div>
            <div class="flex items-center justify-between gap-4 text-xs">
                <span class="text-yellow-400 flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-yellow-400"></span> AWG</span>
                <span id="tooltip-awg" class="font-mono-jb text-white"></span>
            </div>
            <div class="flex items-center justify-between gap-4 text-xs">
                <span class="text-emerald-400 flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span> Dew</span>
                <span id="tooltip-dew" class="font-mono-jb text-white"></span>
            </div>
        </div>
    </div>

    <section id="dashboard" class="pt-32 pb-12 px-6 max-w-7xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
            <div>
                <div class="text-xs font-mono-jb text-cyan-400 mb-2">/// LOCATION: 43.7°N, -79.4°W [TORONTO]</div>
                <h1 class="text-3xl md:text-4xl font-medium text-white tracking-tight">Live Telemetry</h1>
            </div>
            <div class="flex gap-2">
                <button id="sync-btn" onclick="fetchTelemetryData()" class="glass-panel px-3 py-1.5 rounded text-xs text-slate-400 hover:text-white transition-colors border-slate-800 hover:border-slate-600 flex items-center gap-2">
                    <i data-lucide="refresh-cw" class="w-3 h-3" id="sync-icon"></i> Sync Node
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="glass-panel p-5 rounded-xl border-l-4 border-l-cyan-400 relative overflow-hidden group">
                <div class="flex justify-between items-start mb-4">
                    <span class="text-xs font-mono-jb text-cyan-400 uppercase">Active Protocol</span>
                    <i data-lucide="cloud-fog" class="w-4 h-4 text-cyan-400"></i>
                </div>
                <div id="protocol-value" class="text-3xl font-semibold text-white tracking-tight mb-1">--</div>
                <div id="protocol-status" class="text-xs text-slate-500 font-mono-jb">LOADING...</div>
            </div>

            <div class="glass-panel p-5 rounded-xl border-l-4 border-l-yellow-400 group">
                <div class="flex justify-between items-start mb-4">
                    <span class="text-xs font-mono-jb text-yellow-400 uppercase">Yield 24h (Est)</span>
                    <i data-lucide="droplets" class="w-4 h-4 text-yellow-400"></i>
                </div>
                <div id="yield-value" class="text-3xl font-semibold text-white tracking-tight mb-1">-- L</div>
                <div id="yield-status" class="text-xs text-emerald-400 font-mono-jb flex items-center gap-1">
                    <i data-lucide="trending-up" class="w-3 h-3"></i> <span>CALCULATING...</span>
                </div>
            </div>

            <div class="glass-panel p-5 rounded-xl border-l-4 border-l-emerald-400 group">
                <div class="flex justify-between items-start mb-4">
                    <span class="text-xs font-mono-jb text-emerald-400 uppercase">Humidity</span>
                    <i data-lucide="gauge" class="w-4 h-4 text-emerald-400"></i>
                </div>
                <div id="humidity-value" class="text-3xl font-semibold text-white tracking-tight mb-1">--%</div>
                <div id="humidity-status" class="text-xs text-slate-500 font-mono-jb">CURRENT</div>
            </div>

            <div class="glass-panel p-5 rounded-xl border-l-4 border-l-slate-600 group">
                <div class="flex justify-between items-start mb-4">
                    <span class="text-xs font-mono-jb text-slate-400 uppercase">Solar Radiation</span>
                    <i data-lucide="sun" class="w-4 h-4 text-slate-400"></i>
                </div>
                <div id="solar-value" class="text-3xl font-semibold text-white tracking-tight mb-1">-- W/m²</div>
                <div id="solar-status" class="text-xs text-slate-500 font-mono-jb">CURRENT</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 glass-panel rounded-xl p-6 border border-slate-800">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-sm font-medium text-slate-200">Yield Projection (16 Day Forecast)</h3>
                    <div class="flex gap-4 text-xs font-mono-jb">
                        <span class="flex items-center gap-1"><span class="w-2 h-2 bg-cyan-400 rounded-full"></span> Fog</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 bg-yellow-400 rounded-full"></span> AWG</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 bg-emerald-500 rounded-full"></span> Dew</span>
                    </div>
                </div>
                <div id="chart-container" class="relative h-64 w-full border-b border-l border-slate-800 cursor-crosshair">
                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <div class="text-xs font-mono-jb text-slate-500 animate-pulse">LOADING FORECAST DATA...</div>
                    </div>
                </div>
                <div id="chart-labels" class="flex justify-between text-xs font-mono-jb text-slate-500 mt-2 px-2">
                    <span>--</span>
                    <span>--</span>
                    <span>--</span>
                </div>
            </div>

            <div class="glass-panel rounded-xl p-0 overflow-hidden flex flex-col border border-slate-800">
                <div class="px-4 py-3 bg-slate-900/80 border-b border-slate-800 flex justify-between items-center">
                    <span class="text-xs font-medium text-slate-300">System Logs</span>
                    <div class="flex gap-1.5">
                        <div class="w-2.5 h-2.5 rounded-full bg-slate-700"></div>
                        <div class="w-2.5 h-2.5 rounded-full bg-slate-700"></div>
                    </div>
                </div>
                <div id="system-logs" class="p-4 font-mono-jb text-xs leading-relaxed text-slate-400 h-full overflow-y-auto bg-slate-950/50 max-h-64">
                    <div class="mb-2"><span class="text-slate-500">[INIT]</span> Waiting for connection...</div>
                    <div class="mt-2 animate-pulse">_</div>
                </div>
            </div>
        </div>
    </section>

    <section id="history" class="py-12 px-6 max-w-7xl mx-auto border-t border-white/5 bg-slate-900/10">
        <div class="mb-8 flex flex-col md:flex-row justify-between items-end gap-4">
             <div>
                <div class="text-xs font-mono-jb text-indigo-400 mb-2">/// ARCHIVE_DB: READ_ONLY</div>
                <h2 class="text-3xl font-medium text-white tracking-tight">Historic Analysis</h2>
             </div>
             <div class="flex items-center gap-2">
                 <span id="db-status-dot" class="w-2 h-2 rounded-full bg-slate-500"></span>
                 <span id="db-status-text" class="text-xs font-mono-jb text-slate-400">DB_STATUS: STANDBY</span>
             </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="glass-panel p-5 rounded-xl border border-slate-800 h-fit lg:col-span-1">
                <h3 class="text-sm font-medium text-slate-200 mb-4 flex items-center gap-2">
                    <i data-lucide="calendar-range" class="w-4 h-4 text-indigo-400"></i> Date Filter
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-mono-jb text-slate-500 mb-1 uppercase">Start Date</label>
                        <input type="date" id="start-date" class="w-full bg-slate-950 border border-slate-700 text-slate-300 text-xs rounded p-2.5 focus:outline-none focus:border-indigo-500 font-mono-jb">
                    </div>
                    <div>
                         <label class="block text-xs font-mono-jb text-slate-500 mb-1 uppercase">End Date</label>
                         <input type="date" id="end-date" class="w-full bg-slate-950 border border-slate-700 text-slate-300 text-xs rounded p-2.5 focus:outline-none focus:border-indigo-500 font-mono-jb">
                    </div>
                    <button onclick="fetchHistoricData()" class="w-full mt-2 bg-slate-800 hover:bg-slate-700 hover:text-white text-slate-300 text-xs py-2.5 rounded border border-slate-600 transition-colors flex justify-center items-center gap-2 group font-medium">
                        <span>UPDATE VIEW</span>
                        <i data-lucide="arrow-right" class="w-3 h-3 group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </div>
                
                <div class="mt-6 pt-6 border-t border-white/5">
                    <div class="text-xs font-mono-jb text-slate-600 mb-2 uppercase">Quick Ranges</div>
                    <div class="flex gap-2">
                        <button onclick="setQuickRange(7)" class="flex-1 bg-slate-950/50 hover:bg-slate-800 border border-slate-800 hover:border-slate-600 text-slate-400 text-xs py-1.5 rounded transition-colors">7D</button>
                        <button onclick="setQuickRange(30)" class="flex-1 bg-slate-950/50 hover:bg-slate-800 border border-slate-800 hover:border-slate-600 text-slate-400 text-xs py-1.5 rounded transition-colors">30D</button>
                        <button onclick="setQuickRange(365)" class="flex-1 bg-slate-950/50 hover:bg-slate-800 border border-slate-800 hover:border-slate-600 text-slate-400 text-xs py-1.5 rounded transition-colors">YTD</button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-3 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="glass-panel p-4 rounded-lg border border-slate-800 col-span-1">
                        <div class="text-xs text-slate-500 font-mono-jb uppercase">Fog Events</div>
                        <div id="hist-fog-events" class="text-xl font-semibold text-white mt-1">--</div>
                        <div id="hist-fog-status" class="text-xs text-slate-600 mt-1">--</div>
                    </div>
                </div>

                <div class="glass-panel rounded-xl border border-slate-800 p-6 h-72 relative overflow-hidden flex flex-col">
                    <div class="flex justify-between items-center mb-6">
                        <h4 class="text-xs font-medium text-slate-300">Yield History (Line)</h4>
                        <div class="flex gap-4">
                             <div class="flex items-center gap-4 text-xs font-mono-jb">
                                <span class="flex items-center gap-1"><span class="w-2 h-2 bg-cyan-500 rounded-full"></span> Fog</span>
                                <span class="flex items-center gap-1"><span class="w-2 h-2 bg-yellow-500 rounded-full"></span> AWG</span>
                                <span class="flex items-center gap-1"><span class="w-2 h-2 bg-emerald-500 rounded-full"></span> Dew</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="histogram-container" class="flex-grow relative flex items-end justify-between gap-1 px-2 border-b border-slate-800">
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-xs font-mono-jb text-slate-500">Select date range to view data</span>
                        </div>
                    </div>
                    <div id="histogram-labels" class="flex justify-between mt-2 text-xs text-slate-600 font-mono-jb px-1">
                        <span>--</span>
                        <span>--</span>
                        <span>--</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="tech-stack" class="py-20 border-t border-white/5 bg-slate-900/20">
        <div class="max-w-7xl mx-auto px-6">
            <div class="mb-12 flex justify-between items-end">
                <div>
                    <h2 class="text-sm font-mono-jb text-cyan-400 mb-2">/// CLASSIFIED: TECHNOLOGY STACK</h2>
                    <h3 class="text-2xl text-white font-medium tracking-tight">Capture Methods</h3>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Fog Net Card -->
                <div class="glass-panel rounded-xl overflow-hidden border border-slate-800 group hover:border-cyan-500/30 transition-colors flex flex-col h-full">
                    <div class="aspect-video relative bg-slate-900">
                        <img src="static/fognet.jpg" alt="Fog Net Structure" class="absolute inset-0 w-full h-full object-cover opacity-60 group-hover:opacity-100 transition-opacity duration-500">
                        <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/20 to-transparent"></div>
                        <div class="absolute bottom-3 left-3 flex gap-2">
                             <span class="bg-cyan-950/80 border border-cyan-500/30 text-cyan-300 text-xs px-2 py-0.5 rounded font-mono-jb backdrop-blur-md">PASSIVE</span>
                        </div>
                    </div>
                    <div class="p-5 relative flex-grow">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="cloud-fog" class="w-4 h-4 text-cyan-400"></i>
                            <h4 class="text-lg font-medium text-white">Fog Net</h4>
                        </div>
                        <div class="text-2xl font-mono-jb text-white mb-2">3.0 - 10.0 <span class="text-sm text-slate-500">L/day</span></div>
                        <p class="text-sm text-slate-400 leading-relaxed mb-4">
                            Passive mesh structures that thrive in shoulder seasons (spring/autumn) when advection fog events are frequent. Ideal when humidity is high (>90%) and wind flow is steady.
                        </p>
                        <div class="pt-4 mt-auto border-t border-white/5">
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-500 font-mono-jb">MODEL</span>
                                <span class="text-slate-300 font-medium">MIT-14 Standard</span>
                            </div>
                            <div class="flex justify-between text-xs mt-1">
                                <span class="text-slate-500 font-mono-jb">SIZE</span>
                                <span class="text-slate-300 font-medium">1.0 m² Mesh</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active AWG Card -->
                <div class="glass-panel rounded-xl overflow-hidden border border-slate-800 group hover:border-yellow-500/30 transition-colors flex flex-col h-full">
                    <div class="aspect-video relative bg-slate-900">
                        <img src="static/awg.jpg" alt="Active AWG Unit" class="absolute inset-0 w-full h-full object-cover opacity-60 group-hover:opacity-100 transition-opacity duration-500">
                        <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/20 to-transparent"></div>
                        <div class="absolute bottom-3 left-3 flex gap-2">
                             <span class="bg-yellow-950/80 border border-yellow-500/30 text-yellow-300 text-xs px-2 py-0.5 rounded font-mono-jb backdrop-blur-md">ACTIVE</span>
                        </div>
                    </div>
                    <div class="p-5 relative flex-grow">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="sun" class="w-4 h-4 text-yellow-400"></i>
                            <h4 class="text-lg font-medium text-white">Active AWG</h4>
                        </div>
                        <div class="text-2xl font-mono-jb text-white mb-2">2.0 - 15.0 <span class="text-sm text-slate-500">L/day</span></div>
                        <p class="text-sm text-slate-400 leading-relaxed mb-4">
                            Dominate in summer months when high solar radiation powers desorption and warm air holds peak absolute humidity. Efficiency correlates directly with available solar energy.
                        </p>
                        <div class="pt-4 mt-auto border-t border-white/5">
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-500 font-mono-jb">TYPE</span>
                                <span class="text-slate-300 font-medium">Solar-Sorption</span>
                            </div>
                            <div class="flex justify-between text-xs mt-1">
                                <span class="text-slate-500 font-mono-jb">FOOTPRINT</span>
                                <span class="text-slate-300 font-medium">~0.25 m² (50x50cm)</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dew Condenser Card -->
                <div class="glass-panel rounded-xl overflow-hidden border border-slate-800 group hover:border-emerald-500/30 transition-colors flex flex-col h-full">
                    <div class="aspect-video relative bg-slate-900">
                        <img src="static/dew.png" alt="Dew Condenser Roof" class="absolute inset-0 w-full h-full object-cover opacity-60 group-hover:opacity-100 transition-opacity duration-500">
                        <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/20 to-transparent"></div>
                        <div class="absolute bottom-3 left-3 flex gap-2">
                             <span class="bg-emerald-950/80 border border-emerald-500/30 text-emerald-300 text-xs px-2 py-0.5 rounded font-mono-jb backdrop-blur-md">BACKUP</span>
                        </div>
                    </div>
                    <div class="p-5 relative flex-grow">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="droplet" class="w-4 h-4 text-emerald-400"></i>
                            <h4 class="text-lg font-medium text-white">Dew Condenser</h4>
                        </div>
                        <div class="text-2xl font-mono-jb text-white mb-2">0.8 - 2.4 <span class="text-sm text-slate-500">L/day</span></div>
                        <p class="text-sm text-slate-400 leading-relaxed mb-4">
                            Critical zero-energy baseline. While yields are lower, they are consistent on clear nights. Requires zero maintenance and no power, ensuring water security when other systems fail.
                        </p>
                        <div class="pt-4 mt-auto border-t border-white/5">
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-500 font-mono-jb">MODEL</span>
                                <span class="text-slate-300 font-medium">Planar Radiative</span>
                            </div>
                            <div class="flex justify-between text-xs mt-1">
                                <span class="text-slate-500 font-mono-jb">SIZE</span>
                                <span class="text-slate-300 font-medium">1.0 m² Surface</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-12 glass-panel rounded-xl p-6 border border-slate-800">
                <h4 class="text-sm font-medium text-white mb-3 flex items-center gap-2">
                    <i data-lucide="info" class="w-4 h-4 text-slate-400"></i> Model Assumptions
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-xs text-slate-400 font-mono-jb leading-relaxed">
                    <div>
                        <span class="text-cyan-400 block mb-1">/// FOG NET (MIT-14)</span>
                        Yields are normalized to a 1m² vertical mesh surface. Calculations rely on the MIT-14 standard efficiency curve derived from field tests in comparable climates (Pepperwood Preserve).
                    </div>
                    <div>
                        <span class="text-yellow-400 block mb-1">/// ACTIVE AWG</span>
                        Estimates assume a compact, portable unit (approx. 50x50x80cm) powered by 300W solar input. Yields fluctuate based on available solar radiation and ambient absolute humidity.
                    </div>
                    <div>
                        <span class="text-emerald-400 block mb-1">/// DEW CONDENSER</span>
                        Based on data from insulated plain radiative condensers (Wroclaw Study). Yields are normalized to a 1m² horizontal planar surface relying purely on passive radiative cooling.
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer class="py-12 border-t border-white/5 bg-slate-950 text-center relative z-10">
        <div class="max-w-7xl mx-auto px-6">
            <p class="text-xs font-mono-jb text-slate-600 mb-2">AEROAQUA_OS</p>
            <p class="text-xs text-slate-500">© 2025 AeroAqua Project. All systems nominal.</p>
        </div>
    </footer>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // API Configuration - Dynamic for Production
        const API_BASE_URL = window.location.origin + '/api';

        // State management
        let forecastData = null;
        let historicData = null;

        // Initialize dates
        function initializeDates() {
            const today = new Date();
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(today.getDate() - 30);
            
            document.getElementById('end-date').value = today.toISOString().split('T')[0];
            document.getElementById('start-date').value = thirtyDaysAgo.toISOString().split('T')[0];
        }

        // Add log entry
        function addLog(type, message) {
            const logsContainer = document.getElementById('system-logs');
            const colors = {
                'INFO': 'text-emerald-500',
                'SUCCESS': 'text-emerald-500',
                'DATA': 'text-cyan-500',
                'CALC': 'text-yellow-500',
                'ERROR': 'text-red-500',
                'DECISION': 'text-cyan-200'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = 'mb-2';
            
            if (type === 'DECISION') {
                logEntry.innerHTML = `<div class="border-l-2 border-cyan-500 pl-2 text-cyan-200">[${type}] ${message}</div>`;
            } else {
                logEntry.innerHTML = `<span class="${colors[type] || 'text-slate-500'}">[${type}]</span> ${message}`;
            }
            
            // Remove the cursor
            const cursor = logsContainer.querySelector('.animate-pulse');
            if (cursor) cursor.remove();
            
            logsContainer.appendChild(logEntry);
            
            // Add cursor back
            const newCursor = document.createElement('div');
            newCursor.className = 'mt-2 animate-pulse';
            newCursor.textContent = '_';
            logsContainer.appendChild(newCursor);
            
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        // Fetch telemetry data from API
        async function fetchTelemetryData() {
            const syncIcon = document.getElementById('sync-icon');
            syncIcon.classList.add('animate-spin');
            
            addLog('INFO', 'Connecting to OpenMeteo API...');
            
            try {
                const response = await fetch(`${API_BASE_URL}/forecast`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                forecastData = data;
                
                addLog('SUCCESS', `Forecast received (${data.forecast.length} days).`);
                
                // Update metrics
                const today = data.forecast[0];
                addLog('DATA', `RH: ${today.humidity.toFixed(1)}% | Solar: ${today.solar.toFixed(0)} W/m²`);
                addLog('CALC', `Fog Potential: ${today.fog.toFixed(2)}L`);
                addLog('CALC', `AWG Potential: ${today.awg.toFixed(2)}L`);
                addLog('DECISION', `Initiating ${today.best_tech} sequence. Efficiency delta > 15%.`);
                
                updateDashboardMetrics(data);
                renderForecastChart(data.forecast);
                
                // Update system status
                updateSystemStatus('online');
                
            } catch (error) {
                addLog('ERROR', `Connection failed: ${error.message}`);
                updateSystemStatus('offline');
                
                // Use demo data if API fails
                useDemoData();
            }
            
            syncIcon.classList.remove('animate-spin');
        }

        // Update dashboard metrics
        function updateDashboardMetrics(data) {
            const today = data.forecast[0];
            
            document.getElementById('protocol-value').textContent = today.best_tech;
            document.getElementById('protocol-status').textContent = 'OPTIMAL • EFFICIENCY > 15%';
            
            document.getElementById('yield-value').textContent = `${today.best_yield.toFixed(2)} L`;
            document.getElementById('yield-status').querySelector('span').textContent = 'PREDICTED SPIKE';
            
            document.getElementById('humidity-value').textContent = `${today.humidity.toFixed(0)}%`;
            document.getElementById('humidity-status').textContent = today.humidity > 90 ? 'HIGH - FOG LIKELY' : 'NORMAL';
            
            document.getElementById('solar-value').textContent = `${today.solar.toFixed(0)} W/m²`;
            document.getElementById('solar-status').textContent = today.solar > 500 ? 'PEAK OUTPUT' : 'STANDARD';
        }

        // --- INTERACTIVE CHART FUNCTIONS ---

        function showTooltip(evt, data) {
            const tooltip = document.getElementById('global-tooltip');
            const total = data.fog + data.awg + data.dew;

            document.getElementById('tooltip-date').textContent = new Date(data.date).toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
            document.getElementById('tooltip-fog').textContent = `${data.fog.toFixed(1)} L`;
            document.getElementById('tooltip-awg').textContent = `${data.awg.toFixed(1)} L`;
            document.getElementById('tooltip-dew').textContent = `${data.dew.toFixed(1)} L`;
            
            tooltip.style.display = 'block';
            moveTooltip(evt);
        }

        function moveTooltip(evt) {
            const tooltip = document.getElementById('global-tooltip');
            
            let left = evt.clientX;
            let top = evt.clientY - 10;

            tooltip.style.left = `${left}px`;
            tooltip.style.top = `${top}px`;
        }

        function hideTooltip() {
            document.getElementById('global-tooltip').style.display = 'none';
        }

        // Render forecast chart using SVG with Interactivity
        function renderForecastChart(forecast) {
            const container = document.getElementById('chart-container');
            const labelsContainer = document.getElementById('chart-labels');
            
            const maxYield = Math.max(...forecast.map(d => Math.max(d.fog, d.awg, d.dew)));
            // Add a little headroom
            const yMax = maxYield * 1.1; 

            const height = 256;
            const width = container.offsetWidth || 600;
            const padding = 20;
            
            // Helper to scale Y
            const scaleY = (val) => height - padding - (val / yMax) * (height - 2 * padding);
            // Helper to scale X
            const scaleX = (idx) => padding + (idx / (forecast.length - 1)) * (width - 2 * padding);

            // Generate SVG paths
            const genPath = (key) => forecast.map((d, i) => `${scaleX(i)},${scaleY(d[key])}`).join(' L ');
            
            const fogPoints = genPath('fog');
            const awgPoints = genPath('awg');
            const dewPoints = genPath('dew');
            
            // Grid lines
            let gridLines = '';
            for (let i = 0; i < 4; i++) {
                const y = padding + (i / 3) * (height - 2 * padding);
                gridLines += `<line x1="${padding}" y1="${y}" x2="${width - padding}" y2="${y}" stroke="#1e293b" stroke-width="1" stroke-dasharray="4"/>`;
            }
            
            // Interactive Areas (Rects)
            let interactionLayer = '';
            // We create a vertical rect for each data point that captures hover
            const stepWidth = (width - 2 * padding) / (forecast.length - 1);
            
            forecast.forEach((d, i) => {
                const xCenter = scaleX(i);
                const xStart = i === 0 ? padding : xCenter - stepWidth/2;
                const rectWidth = (i === 0 || i === forecast.length - 1) ? stepWidth/2 : stepWidth;
                
                const guideId = `guide-${i}`;
                
                interactionLayer += `
                    <g class="group">
                        <line id="${guideId}" x1="${xCenter}" y1="${padding}" x2="${xCenter}" y2="${height-padding}" stroke="white" stroke-width="1" stroke-dasharray="2" opacity="0" class="transition-opacity duration-200 pointer-events-none"/>
                        <rect x="${xStart}" y="0" width="${rectWidth}" height="${height}" fill="transparent" 
                            onmouseenter="document.getElementById('${guideId}').style.opacity = 0.3; showTooltip(event, ${JSON.stringify(d).replace(/"/g, "&quot;")})"
                            onmousemove="moveTooltip(event)"
                            onmouseleave="document.getElementById('${guideId}').style.opacity = 0; hideTooltip()"
                        />
                        <circle cx="${xCenter}" cy="${scaleY(d.fog)}" r="3" fill="#22d3ee" opacity="0" class="group-hover:opacity-100 transition-opacity pointer-events-none"/>
                        <circle cx="${xCenter}" cy="${scaleY(d.awg)}" r="3" fill="#facc15" opacity="0" class="group-hover:opacity-100 transition-opacity pointer-events-none"/>
                        <circle cx="${xCenter}" cy="${scaleY(d.dew)}" r="3" fill="#34d399" opacity="0" class="group-hover:opacity-100 transition-opacity pointer-events-none"/>
                    </g>
                `;
            });

            container.innerHTML = `
                <svg class="absolute inset-0 h-full w-full" viewBox="0 0 ${width} ${height}" preserveAspectRatio="none">
                    ${gridLines}
                    <path d="M ${fogPoints}" fill="none" stroke="#22d3ee" stroke-width="2" class="opacity-80"/>
                    <path d="M ${awgPoints}" fill="none" stroke="#facc15" stroke-width="2" class="opacity-80"/>
                    <path d="M ${dewPoints}" fill="none" stroke="#34d399" stroke-width="2" class="opacity-60"/>
                    ${interactionLayer}
                </svg>
            `;
            
            // Update labels
            const dates = forecast.map(d => new Date(d.date).toLocaleDateString(undefined, {month:'short', day:'numeric'}));
            labelsContainer.innerHTML = `
                <span>${dates[0]}</span>
                <span>${dates[Math.floor(dates.length / 2)]}</span>
                <span>${dates[dates.length - 1]}</span>
            `;
        }

        // Fetch historic data
        async function fetchHistoricData() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            updateDbStatus('loading');
            
            try {
                const response = await fetch(`${API_BASE_URL}/historic?start=${startDate}&end=${endDate}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                historicData = data;
                
                updateHistoricMetrics(data);
                renderHistogram(data.daily);
                updateDbStatus('online');
                
            } catch (error) {
                console.error('Historic data fetch failed:', error);
                updateDbStatus('offline');
                
                // Use demo historic data
                useDemoHistoricData();
            }
        }

        // Update historic metrics - REMOVED TOTAL/AVG/PEAK logic
        function updateHistoricMetrics(data) {
            // Only update what is still in the DOM
            document.getElementById('hist-fog-events').textContent = data.summary.fog_events;
            document.getElementById('hist-fog-status').textContent = data.summary.fog_events > 10 ? 'High Activity' : 'Normal Activity';
            document.getElementById('hist-fog-status').className = `text-xs mt-1 ${data.summary.fog_events > 10 ? 'text-indigo-400' : 'text-slate-600'}`;
        }

        // Render histogram - UPDATED FOR LINE CHART (Historic)
        function renderHistogram(daily) {
            const container = document.getElementById('histogram-container');
            const labelsContainer = document.getElementById('histogram-labels');
            
            // 1. Calculate Max Y for scaling (across all 3 metrics)
            const maxYield = Math.max(
                ...daily.map(d => Math.max(d.fog, d.awg, d.dew)),
                1
            );
            const yMax = maxYield * 1.1; // Add 10% headroom

            // 2. Dimensions
            const height = container.offsetHeight || 250;
            const width = container.offsetWidth || 800;
            const padding = 10; // internal padding inside SVG

            // 3. Scaling functions
            const scaleY = (val) => height - padding - (val / yMax) * (height - 2 * padding);
            const scaleX = (idx) => padding + (idx / (daily.length - 1)) * (width - 2 * padding);

            // 4. Generate Paths
            const genPath = (key) => daily.map((d, i) => `${scaleX(i)},${scaleY(d[key])}`).join(' L ');

            const fogPoints = genPath('fog');
            const awgPoints = genPath('awg');
            const dewPoints = genPath('dew');
            
            // 5. Grid lines
            let gridLines = '';
            for (let i = 0; i < 4; i++) {
                const y = padding + (i / 3) * (height - 2 * padding);
                gridLines += `<line x1="${padding}" y1="${y}" x2="${width - padding}" y2="${y}" stroke="#1e293b" stroke-width="1" stroke-dasharray="4"/>`;
            }
            
            // 6. Interaction Layer
            let interactionLayer = '';
            const stepWidth = (width - 2 * padding) / (daily.length - 1);
            
            daily.forEach((d, i) => {
                const xCenter = scaleX(i);
                const xStart = i === 0 ? padding : xCenter - stepWidth/2;
                const rectWidth = (i === 0 || i === daily.length - 1) ? stepWidth/2 : stepWidth;
                
                const guideId = `hist-guide-${i}`;
                const tooltipData = {
                    date: d.date,
                    fog: d.fog,
                    awg: d.awg,
                    dew: d.dew
                };

                interactionLayer += `
                    <g class="group">
                        <line id="${guideId}" x1="${xCenter}" y1="${padding}" x2="${xCenter}" y2="${height-padding}" stroke="white" stroke-width="1" stroke-dasharray="2" opacity="0" class="transition-opacity duration-200 pointer-events-none"/>
                        <rect x="${xStart}" y="0" width="${rectWidth}" height="${height}" fill="transparent" 
                            onmouseenter="document.getElementById('${guideId}').style.opacity = 0.3; showTooltip(event, ${JSON.stringify(tooltipData).replace(/"/g, "&quot;")})"
                            onmousemove="moveTooltip(event)"
                            onmouseleave="document.getElementById('${guideId}').style.opacity = 0; hideTooltip()"
                        />
                        <circle cx="${xCenter}" cy="${scaleY(d.fog)}" r="3" fill="#22d3ee" opacity="0" class="group-hover:opacity-100 transition-opacity pointer-events-none"/>
                        <circle cx="${xCenter}" cy="${scaleY(d.awg)}" r="3" fill="#facc15" opacity="0" class="group-hover:opacity-100 transition-opacity pointer-events-none"/>
                        <circle cx="${xCenter}" cy="${scaleY(d.dew)}" r="3" fill="#34d399" opacity="0" class="group-hover:opacity-100 transition-opacity pointer-events-none"/>
                    </g>
                `;
            });
            
            // 7. Inject SVG
            container.innerHTML = `
                <svg class="absolute inset-0 h-full w-full" viewBox="0 0 ${width} ${height}" preserveAspectRatio="none">
                    ${gridLines}
                    <path d="M ${fogPoints}" fill="none" stroke="#22d3ee" stroke-width="1.5" class="opacity-90"/>
                    <path d="M ${awgPoints}" fill="none" stroke="#facc15" stroke-width="1.5" class="opacity-90"/>
                    <path d="M ${dewPoints}" fill="none" stroke="#34d399" stroke-width="1.5" class="opacity-90"/>
                    ${interactionLayer}
                </svg>
            `;
            
            // Update labels
            const dates = daily.map(d => new Date(d.date).toLocaleDateString(undefined, {month:'short', day:'numeric'}));
            labelsContainer.innerHTML = `
                <span>${dates[0]}</span>
                <span>${dates[Math.floor(dates.length / 2)]}</span>
                <span>${dates[dates.length - 1]}</span>
            `;
        }

        // Set quick date range
        function setQuickRange(days) {
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - days);
            
            document.getElementById('end-date').value = today.toISOString().split('T')[0];
            document.getElementById('start-date').value = startDate.toISOString().split('T')[0];
            
            fetchHistoricData();
        }

        // Demo data functions (fallback when API is unavailable)
        function useDemoData() {
            addLog('INFO', 'Using demo data...');
            
            const demoForecast = [];
            const today = new Date();
            
            for (let i = 0; i < 16; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                
                const fog = Math.max(0, 5 + Math.sin(i * 0.5) * 8 + Math.random() * 3);
                const awg = Math.max(0, 3 + Math.cos(i * 0.3) * 6 + Math.random() * 2);
                const dew = Math.max(0, 0.2 + Math.random() * 0.4);
                const best = Math.max(fog, awg, dew);
                const best_tech = best === fog ? 'FOG' : best === awg ? 'AWG' : 'DEW';
                
                demoForecast.push({
                    date: date.toISOString().split('T')[0],
                    fog: fog,
                    awg: awg,
                    dew: dew,
                    best_yield: best,
                    best_tech: best_tech,
                    humidity: 70 + Math.random() * 25,
                    solar: 200 + Math.random() * 600
                });
            }
            
            forecastData = { forecast: demoForecast };
            
            addLog('DATA', `RH: ${demoForecast[0].humidity.toFixed(1)}% | Solar: ${demoForecast[0].solar.toFixed(0)} W/m²`);
            addLog('CALC', `Fog Potential: ${demoForecast[0].fog.toFixed(2)}L`);
            addLog('CALC', `AWG Potential: ${demoForecast[0].awg.toFixed(2)}L`);
            addLog('DECISION', `Initiating ${demoForecast[0].best_tech} sequence. Efficiency delta > 15%.`);
            
            updateDashboardMetrics(forecastData);
            renderForecastChart(demoForecast);
        }

        function useDemoHistoricData() {
            const startDate = new Date(document.getElementById('start-date').value);
            const endDate = new Date(document.getElementById('end-date').value);
            const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            
            const daily = [];
            let fogEvents = 0;
            
            for (let i = 0; i < days; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const fog = Math.max(0, (Math.sin(i * 0.2) > 0.5 ? Math.random() * 20 : Math.random() * 2));
                const awg = Math.max(0, 10 + Math.cos(i * 0.1) * 5 + Math.random() * 3);
                const dew = Math.random() * 1;
                
                if (fog > 5) fogEvents++;
                
                daily.push({
                    date: date.toISOString().split('T')[0],
                    fog: fog,
                    awg: awg,
                    dew: dew
                });
            }
            
            const demoHistoric = {
                summary: {
                    fog_events: fogEvents
                },
                daily: daily
            };
            
            updateHistoricMetrics(demoHistoric);
            renderHistogram(daily);
            updateDbStatus('online');
        }

        // Update system status
        function updateSystemStatus(status) {
            const statusEl = document.getElementById('system-status');
            const statusText = statusEl.querySelector('span:last-child');
            const statusDot = statusEl.querySelector('span:first-child');
            
            if (status === 'online') {
                statusDot.className = 'w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse';
                statusText.className = 'text-xs font-mono-jb text-emerald-400 tracking-tight uppercase';
                statusText.textContent = 'System Online';
                statusEl.className = 'hidden sm:flex items-center gap-2 px-3 py-1 rounded-full bg-emerald-500/10 border border-emerald-500/20';
            } else {
                statusDot.className = 'w-1.5 h-1.5 rounded-full bg-red-500';
                statusText.className = 'text-xs font-mono-jb text-red-400 tracking-tight uppercase';
                statusText.textContent = 'Demo Mode';
                statusEl.className = 'hidden sm:flex items-center gap-2 px-3 py-1 rounded-full bg-red-500/10 border border-red-500/20';
            }
        }

        // Update DB status
        function updateDbStatus(status) {
            const dot = document.getElementById('db-status-dot');
            const text = document.getElementById('db-status-text');
            
            if (status === 'online') {
                dot.className = 'w-2 h-2 rounded-full bg-indigo-500 animate-pulse';
                text.className = 'text-xs font-mono-jb text-indigo-300';
                text.textContent = 'DB_STATUS: ONLINE';
            } else if (status === 'loading') {
                dot.className = 'w-2 h-2 rounded-full bg-yellow-500 animate-pulse';
                text.className = 'text-xs font-mono-jb text-yellow-300';
                text.textContent = 'DB_STATUS: QUERYING...';
            } else {
                dot.className = 'w-2 h-2 rounded-full bg-slate-500';
                text.className = 'text-xs font-mono-jb text-slate-400';
                text.textContent = 'DB_STATUS: DEMO';
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            initializeDates();
            fetchTelemetryData();
        });
    </script>
</body></html>
